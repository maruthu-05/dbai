<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Database Query Assistant</title>
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <div class="container auth-check ready">
        <header>
            <div class="header-content">
                <div>
                    <h1>AI Database Query Assistant</h1>
                    <p>Ask questions in natural language and get database results</p>
                </div>
                <div class="header-actions">
                    <span id="connection-info" class="connection-info">Loading connection...</span>
                    <button class="btn btn-secondary" id="back-to-dashboard">‚Üê Dashboard</button>
                </div>
            </div>
        </header>

        <!-- Connection Loading -->
        <div id="connection-loading" class="step active">
            <div class="loading-connection">
                <div class="spinner"></div>
                <h2>Loading your database connection...</h2>
                <p>Please wait while we prepare your workspace</p>
                <div id="debug-info"
                    style="margin-top: 20px; padding: 10px; background: #f0f0f0; border-radius: 5px; font-family: monospace; font-size: 12px;">
                    <div>Debug Info:</div>
                    <div id="debug-connection-id">Connection ID: Loading...</div>
                    <div id="debug-database-name">Database: Loading...</div>
                    <div id="debug-token">Token: Loading...</div>
                </div>
            </div>
        </div>

        <!-- Table Selection -->
        <div id="table-selection" class="step">
            <div class="step-header">
                <button class="back-btn" id="back-to-dashboard-from-tables">‚Üê Dashboard</button>
                <h2>Select Tables/Collections</h2>
            </div>
            <p>Choose the tables you want to query:</p>
            <div id="tables-list" class="tables-container">
                <!-- Tables will be loaded here -->
            </div>
            <div class="table-actions">
                <button id="select-all-tables">Select All</button>
                <button id="proceed-to-query" disabled>Proceed to Query</button>
            </div>
        </div>

        <!-- Query Interface -->
        <div id="query-interface" class="step">
            <div class="step-header">
                <button class="back-btn" id="back-to-tables">‚Üê Back to Tables</button>
                <h2>Ask Your Question</h2>
            </div>
            <div class="selected-tables-info">
                <h3>Selected Tables:</h3>
                <div id="selected-tables-display"></div>
            </div>
            <div class="table-schemas-section">
                <h3>Table Structure:</h3>
                <div id="table-schemas-info" class="schemas-container">
                    <!-- Table schemas will be loaded here -->
                </div>
            </div>
            <div class="query-section">
                <textarea id="natural-query"
                    placeholder="Ask your question in natural language, e.g., 'Show me all users who registered last month'"></textarea>
                <div class="query-controls">
                    <button id="submit-query">Generate Query</button>
                    <select id="output-format">
                        <option value="chat">Chat Format</option>
                        <option value="table">Table Format</option>
                        <option value="json">JSON File</option>
                        <option value="csv">CSV File</option>
                    </select>
                </div>
            </div>

            <div id="generated-query" class="hidden">
                <h3>Generated Query:</h3>
                <pre id="query-display"></pre>
                <div class="query-actions">
                    <button id="execute-query">Execute Query</button>
                    <button id="edit-query">Edit Query</button>
                    <button class="back-btn" id="new-query">‚Üê New Query</button>
                </div>
            </div>

            <div id="results" class="hidden">
                <h3>Results:</h3>
                <div id="results-content"></div>
                <div class="results-actions">
                    <button id="download-results" class="hidden">Download Results</button>
                    <button class="back-btn" id="back-to-query">‚Üê Ask Another Question</button>
                </div>
            </div>
        </div>

        <!-- Loading Spinner -->
        <div id="loading" class="hidden">
            <div class="spinner"></div>
            <p>Processing your request...</p>
        </div>
    </div>

    <script>
        console.log('üöÄ Query page script starting...');

        // Simple initialization without complex loading
        document.addEventListener('DOMContentLoaded', function () {
            console.log('üìÑ DOM loaded');

            const connectionId = localStorage.getItem('selectedConnectionId');
            const databaseName = localStorage.getItem('selectedDatabase');
            const token = localStorage.getItem('supabase_token');

            console.log('Debug values:', { connectionId, databaseName, token: token ? 'present' : 'missing' });

            // Update debug info
            if (document.getElementById('debug-connection-id')) {
                document.getElementById('debug-connection-id').textContent = `Connection ID: ${connectionId || 'Not found'}`;
            }
            if (document.getElementById('debug-database-name')) {
                document.getElementById('debug-database-name').textContent = `Database: ${databaseName || 'Not found'}`;
            }
            if (document.getElementById('debug-token')) {
                document.getElementById('debug-token').textContent = `Token: ${token ? 'Present' : 'Missing'}`;
            }

            // Check if we have the required data
            if (!connectionId || !databaseName) {
                alert('Missing connection information. Redirecting to dashboard.');
                window.location.href = '/dashboard';
                return;
            }

            // Show table selection directly after 2 seconds
            setTimeout(() => {
                console.log('‚è∞ Timeout reached, showing table selection');
                document.getElementById('connection-loading').classList.remove('active');
                document.getElementById('table-selection').classList.add('active');
                
                // Update connection info
                document.getElementById('connection-info').textContent = `Connection: ${connectionId} ‚Üí ${databaseName}`;
                
                // Add a simple message in tables list
                document.getElementById('tables-list').innerHTML = `
                    <div style="padding: 20px; text-align: center;">
                        <p>Loading tables for database: <strong>${databaseName}</strong></p>
                        <p>Connection ID: <strong>${connectionId}</strong></p>
                        <button onclick="loadTables()" style="margin-top: 10px; padding: 10px 20px;">Load Tables</button>
                    </div>
                `;
            }, 2000);

            // Add back to dashboard functionality
            document.getElementById('back-to-dashboard').addEventListener('click', () => {
                window.location.href = '/dashboard';
            });

            // Add other navigation handlers
            document.getElementById('back-to-dashboard-from-tables').addEventListener('click', () => {
                window.location.href = '/dashboard';
            });

            document.getElementById('back-to-tables').addEventListener('click', () => {
                document.getElementById('query-interface').classList.remove('active');
                document.getElementById('table-selection').classList.add('active');
            });

            // Query submission handler
            document.getElementById('submit-query').addEventListener('click', () => {
                generateQuery();
            });
        });

        // Generate query function
        async function generateQuery() {
            const naturalQuery = document.getElementById('natural-query').value.trim();
            
            if (!naturalQuery) {
                alert('Please enter a question.');
                return;
            }
            
            console.log('üîÑ Generating query for:', naturalQuery);
            
            const token = localStorage.getItem('supabase_token');
            const connectionId = localStorage.getItem('selectedConnectionId');
            const databaseName = localStorage.getItem('selectedDatabase');
            const selectedTables = JSON.parse(localStorage.getItem('selectedTables') || '[]');
            
            // Show loading
            document.getElementById('submit-query').disabled = true;
            document.getElementById('submit-query').textContent = 'Generating...';
            
            try {
                // Get connection details
                const connectionResponse = await fetch(`/api/selected-connection?id=${connectionId}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const connectionResult = await connectionResponse.json();
                const connection = connectionResult.connection;
                
                const credentials = {
                    ...connection.credentials,
                    database: databaseName
                };

                // Generate query
                const queryResponse = await fetch('/api/generate-query', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        naturalLanguage: naturalQuery,
                        dbType: connection.dbType,
                        selectedTables: selectedTables,
                        credentials: credentials
                    })
                });

                const queryResult = await queryResponse.json();
                
                if (queryResult.success) {
                    document.getElementById('query-display').textContent = queryResult.query;
                    document.getElementById('generated-query').classList.remove('hidden');
                    
                    // Store the generated query
                    window.currentQuery = queryResult.query;
                    
                    // Add execute query handler
                    document.getElementById('execute-query').onclick = () => executeQuery(queryResult.query);
                } else {
                    throw new Error(queryResult.error);
                }

            } catch (error) {
                console.error('‚ùå Error generating query:', error);
                alert(`Error generating query: ${error.message}`);
            } finally {
                document.getElementById('submit-query').disabled = false;
                document.getElementById('submit-query').textContent = 'Generate Query';
            }
        }

        // Execute query function
        async function executeQuery(query) {
            console.log('üîÑ Executing query:', query);
            
            const token = localStorage.getItem('supabase_token');
            const connectionId = localStorage.getItem('selectedConnectionId');
            const databaseName = localStorage.getItem('selectedDatabase');
            
            document.getElementById('execute-query').disabled = true;
            document.getElementById('execute-query').textContent = 'Executing...';
            
            try {
                // Get connection details
                const connectionResponse = await fetch(`/api/selected-connection?id=${connectionId}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const connectionResult = await connectionResponse.json();
                const connection = connectionResult.connection;
                
                const credentials = {
                    ...connection.credentials,
                    database: databaseName
                };

                // Execute query
                const executeResponse = await fetch('/api/execute-query', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        query: query,
                        dbType: connection.dbType,
                        credentials: credentials
                    })
                });

                const executeResult = await executeResponse.json();
                
                if (executeResult.success) {
                    displayResults(executeResult.results);
                    document.getElementById('results').classList.remove('hidden');
                } else {
                    throw new Error(executeResult.error);
                }

            } catch (error) {
                console.error('‚ùå Error executing query:', error);
                alert(`Error executing query: ${error.message}`);
            } finally {
                document.getElementById('execute-query').disabled = false;
                document.getElementById('execute-query').textContent = 'Execute Query';
            }
        }

        // Display results function
        function displayResults(results) {
            console.log('üìä Displaying results:', results);
            
            if (!results || results.length === 0) {
                document.getElementById('results-content').innerHTML = '<p>No results found.</p>';
                return;
            }
            
            // Create table
            let html = '<table style="width: 100%; border-collapse: collapse; margin-top: 10px;">';
            
            // Headers
            const headers = Object.keys(results[0]);
            html += '<thead><tr>';
            headers.forEach(header => {
                html += `<th style="border: 1px solid #ddd; padding: 8px; background: #f5f5f5;">${header}</th>`;
            });
            html += '</tr></thead>';
            
            // Rows
            html += '<tbody>';
            results.forEach(row => {
                html += '<tr>';
                headers.forEach(header => {
                    const value = row[header];
                    html += `<td style="border: 1px solid #ddd; padding: 8px;">${value !== null && value !== undefined ? value : ''}</td>`;
                });
                html += '</tr>';
            });
            html += '</tbody></table>';
            
            document.getElementById('results-content').innerHTML = html;
        });

        // Table loading function
        async function loadTables() {
            console.log('üîÑ Loading tables...');
            const token = localStorage.getItem('supabase_token');
            const connectionId = localStorage.getItem('selectedConnectionId');
            const databaseName = localStorage.getItem('selectedDatabase');
            
            document.getElementById('tables-list').innerHTML = '<div style="padding: 20px; text-align: center;">Loading tables...</div>';
            
            try {
                // First get the connection details
                const connectionResponse = await fetch(`/api/selected-connection?id=${connectionId}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!connectionResponse.ok) {
                    throw new Error(`Failed to load connection: ${connectionResponse.status}`);
                }

                const connectionResult = await connectionResponse.json();
                const connection = connectionResult.connection;
                
                console.log('‚úÖ Connection loaded:', connection);

                // Prepare credentials with the selected database
                const credentials = {
                    ...connection.credentials,
                    database: databaseName
                };

                // Now get the tables
                const tablesResponse = await fetch('/api/get-tables', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        dbType: connection.dbType,
                        credentials: credentials
                    })
                });

                const tablesResult = await tablesResponse.json();
                console.log('üìã Tables result:', tablesResult);

                if (tablesResult.success) {
                    displayTables(tablesResult.tables, connection.dbType);
                } else {
                    throw new Error(tablesResult.error);
                }

            } catch (error) {
                console.error('‚ùå Error loading tables:', error);
                document.getElementById('tables-list').innerHTML = `
                    <div style="padding: 20px; text-align: center; color: red;">
                        <p>Error loading tables: ${error.message}</p>
                        <button onclick="loadTables()" style="margin-top: 10px; padding: 10px 20px;">Retry</button>
                    </div>
                `;
            }
        }

        // Display tables function
        function displayTables(tables, dbType) {
            console.log('üìä Displaying tables:', tables);
            
            if (!tables || tables.length === 0) {
                document.getElementById('tables-list').innerHTML = `
                    <div style="padding: 20px; text-align: center;">
                        <p>No tables found in this database.</p>
                        <button onclick="loadTables()" style="margin-top: 10px; padding: 10px 20px;">Retry</button>
                    </div>
                `;
                return;
            }

            let html = '<div class="tables-grid" style="display: grid; gap: 10px; padding: 20px;">';
            
            tables.forEach((table, index) => {
                const tableName = table.name || table;
                const tableType = table.type || (dbType === 'mongodb' ? 'collection' : 'table');
                
                html += `
                    <div class="table-item" style="display: flex; align-items: center; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                        <input type="checkbox" id="table-${index}" value="${tableName}" style="margin-right: 10px;">
                        <label for="table-${index}" style="flex: 1; cursor: pointer;">
                            <strong>${tableName}</strong>
                            <span style="color: #666; margin-left: 10px;">(${tableType})</span>
                        </label>
                    </div>
                `;
            });
            
            html += '</div>';
            document.getElementById('tables-list').innerHTML = html;

            // Enable the proceed button when tables are selected
            const checkboxes = document.querySelectorAll('#tables-list input[type="checkbox"]');
            const proceedBtn = document.getElementById('proceed-to-query');
            
            checkboxes.forEach(checkbox => {
                checkbox.addEventListener('change', () => {
                    const selectedCount = document.querySelectorAll('#tables-list input[type="checkbox"]:checked').length;
                    proceedBtn.disabled = selectedCount === 0;
                });
            });

            // Select all functionality
            document.getElementById('select-all-tables').onclick = () => {
                const allChecked = document.querySelectorAll('#tables-list input[type="checkbox"]:checked').length === checkboxes.length;
                checkboxes.forEach(cb => cb.checked = !allChecked);
                proceedBtn.disabled = document.querySelectorAll('#tables-list input[type="checkbox"]:checked').length === 0;
            };

            // Proceed to query functionality
            proceedBtn.onclick = () => {
                const selectedTables = [];
                document.querySelectorAll('#tables-list input[type="checkbox"]:checked').forEach(cb => {
                    selectedTables.push(cb.value);
                });
                
                if (selectedTables.length === 0) {
                    alert('Please select at least one table.');
                    return;
                }
                
                console.log('‚úÖ Selected tables:', selectedTables);
                
                // Store selected tables
                localStorage.setItem('selectedTables', JSON.stringify(selectedTables));
                
                // Show query interface
                document.getElementById('table-selection').classList.remove('active');
                document.getElementById('query-interface').classList.add('active');
                
                // Display selected tables
                document.getElementById('selected-tables-display').innerHTML = 
                    selectedTables.map(table => `<span style="background: #e3f2fd; padding: 5px 10px; margin: 2px; border-radius: 3px; display: inline-block;">${table}</span>`).join('');
                
                // Load table schemas
                loadTableSchemas(selectedTables);
            };
        }

        // Load table schemas function
        async function loadTableSchemas(selectedTables) {
            console.log('üîÑ Loading table schemas for:', selectedTables);
            
            const token = localStorage.getItem('supabase_token');
            const connectionId = localStorage.getItem('selectedConnectionId');
            const databaseName = localStorage.getItem('selectedDatabase');
            
            document.getElementById('table-schemas-info').innerHTML = '<div style="padding: 20px;">Loading table structures...</div>';
            
            try {
                // Get connection details first
                const connectionResponse = await fetch(`/api/selected-connection?id=${connectionId}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const connectionResult = await connectionResponse.json();
                const connection = connectionResult.connection;
                
                const credentials = {
                    ...connection.credentials,
                    database: databaseName
                };

                // Get table schemas
                const schemasResponse = await fetch('/api/get-table-schemas', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        dbType: connection.dbType,
                        credentials: credentials,
                        selectedTables: selectedTables
                    })
                });

                const schemasResult = await schemasResponse.json();
                
                if (schemasResult.success) {
                    displayTableSchemas(schemasResult.schemas);
                } else {
                    throw new Error(schemasResult.error);
                }

            } catch (error) {
                console.error('‚ùå Error loading schemas:', error);
                document.getElementById('table-schemas-info').innerHTML = `
                    <div style="padding: 20px; color: red;">
                        Error loading table structures: ${error.message}
                    </div>
                `;
            }
        }

        // Display table schemas
        function displayTableSchemas(schemas) {
            console.log('üìä Displaying schemas:', schemas);
            
            let html = '<div style="padding: 20px;">';
            
            Object.keys(schemas).forEach(tableName => {
                const columns = schemas[tableName];
                html += `
                    <div style="margin-bottom: 20px; border: 1px solid #ddd; border-radius: 5px; padding: 15px;">
                        <h4 style="margin: 0 0 10px 0; color: #333;">${tableName}</h4>
                        <div style="display: grid; gap: 5px;">
                `;
                
                columns.forEach(col => {
                    html += `
                        <div style="display: flex; justify-content: space-between; padding: 5px; background: #f9f9f9; border-radius: 3px;">
                            <span style="font-weight: bold;">${col.name}</span>
                            <span style="color: #666;">${col.type}</span>
                        </div>
                    `;
                });
                
                html += '</div></div>';
            });
            
            html += '</div>';
            document.getElementById('table-schemas-info').innerHTML = html;
        }
    </script>
</body>

</html>